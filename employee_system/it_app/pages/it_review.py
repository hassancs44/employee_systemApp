import streamlit as st
import gspread
from google.oauth2.service_account import Credentials
from gspread_dataframe import get_as_dataframe
import os

# â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
# 1) Ù…ØµØ§Ø¯Ù‚Ø© Google Sheets API Ø¹Ø¨Ø± Streamlit Secrets
# â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
SCOPES = [
    "https://www.googleapis.com/auth/spreadsheets",
    "https://www.googleapis.com/auth/drive.file",
]
creds = Credentials.from_service_account_info(
    st.secrets["gcp_service_account"],
    scopes=SCOPES
)
gc = gspread.authorize(creds)

# â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
# 2) Ø§ÙØªØ­ Ù…Ù„Ù Ø§Ù„Ù€Spreadsheet ÙˆØ§Ù„ÙˆØ±Ù‚Ø© â€œRequestsâ€
# â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
SPREADSHEET_ID = st.secrets["gcp_service_account"]["spreadsheet_id"]
sh = gc.open_by_key(SPREADSHEET_ID)
ws_requests = sh.worksheet("Requests")

# â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
# 3) Ù…Ø¬Ù„Ù‘Ø¯ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª Ù…Ø­Ù„ÙŠÙ‹Ø§ (Ø£Ù†Ø´Ø¦ Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ù‹Ø§)
# â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
ATTACH_DIR = "attachments"
os.makedirs(ATTACH_DIR, exist_ok=True)

# â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
# 4) Ø¥Ø¹Ø¯Ø§Ø¯ ÙˆØ§Ø¬Ù‡Ø© Streamlit
# â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
st.set_page_config(page_title="Ù‚Ø³Ù… IT - Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„ÙˆØ§Ø±Ø¯Ø©", layout="wide")
st.markdown("<h2 style='color:#006db3;'>Ù‚Ø³Ù… ØªÙ‚Ù†ÙŠØ© Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª - Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„ÙˆØ§Ø±Ø¯Ø©</h2>", unsafe_allow_html=True)
st.markdown("---")

# â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
# 5) Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† ÙˆØ±Ù‚Ø© Requests ÙˆØ¹Ø±Ø¶Ù‡Ø§
# â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
df = get_as_dataframe(ws_requests).dropna(how="all")

if df.empty:
    st.info("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹.")
else:
    for idx, row in df.iterrows():
        with st.expander(f"ğŸ”¹ {row['Ø§Ù„Ø§Ø³Ù…']} â€“ {row['Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©']}"):
            st.write(f"**Ø§Ù„Ø¬Ù†Ø³ÙŠØ©:** {row['Ø§Ù„Ø¬Ù†Ø³ÙŠØ©']}")
            st.write(f"**ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ø±Ø³Ø§Ù„:** {row['ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ø±Ø³Ø§Ù„']}")
            st.write(f"**Ø§Ù„Ø­Ø§Ù„Ø©:** {row['Ø§Ù„Ø­Ø§Ù„Ø©']}")

            # Ø²Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø±ÙÙ‚ Ø¥Ù† ÙˆÙØ¬Ø¯
            fname = row.get("Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù", "")
            if fname:
                path = os.path.join(ATTACH_DIR, fname)
                if os.path.exists(path):
                    with open(path, "rb") as f:
                        st.download_button(
                            label="ğŸ“¥ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ù…Ø±ÙÙ‚",
                            data=f,
                            file_name=fname,
                            mime="application/octet-stream"
                        )
                else:
                    st.warning("âŒ Ø§Ù„Ù…Ø±ÙÙ‚ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯.")
